# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 1: User Rights Enumeration Through SAMR & GPOLocalGroup

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/
Краткое содержание: 

<blockquote>
However, it is not always clear how the data is gathered without looking at the code of SharpHound, the data ingestor for BloodHound.   ...   
SharpHound will try to enumerate this information from local group membership and BloodHound displays it with the following edges:   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the samr named pipe (this is similar to opening a file with that name) Bind to the samr interface with its UUID 12345778-1234-abcd-ef00-0123456789ac using RPC over SMB Interact using the Security Account Manager (SAM) Remote Protocol The SIDs of users and groups inside of the local group are queried using the function GetMembersInAlias Close and logoff   ...   
SAMR otherwise returns domain users from the ntds.dit database instead of local users.   ...   
Faced with the limitations of SAMR, we will look at the second way SharpHound gathers user rights, the GPOLocalGroup collection method.   ...   
List all OUs that have a GPO linked (gpLink attribute in LDAP) Skip gpLink that contains no computer object, or are disabled Process the gPCFileSysPath attribute of each linked GPO object (this attribute specifies where on SYSVOL the files containing the rules are stored) Search for Groups.xml (for Local Users and Groups) and GptTmpl.inf (for Restricted Groups) in all gPCFileSysPath Filter for SID we’re interested in: Administrators (S-1-5-32-544…..) Remote Desktop Users (S-1-5-32-555…..) Remote Management Users (S-1-5-32-580…..) Distributed COM Users (S-1-5-32-562…..) Resolve what domain users belong to these groups and which computers these GPOs are applied to.   ...   
The completeness of the gathered data will highly vary from domain to domain as some environments heavily rely on GPO to manage local group memberships and other won’t use them at all.   ...   
By default, GPOs are readable by all Authenticated Users, which makes this collection method a good candidate for pentesters and attackers.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 1: User Rights Enumeration Through SAMR & GPOLocalGroup

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/
Краткое содержание: 

<blockquote>
However, it is not always clear how the data is gathered without looking at the code of SharpHound, the data ingestor for BloodHound.   ...   
SharpHound will try to enumerate this information from local group membership and BloodHound displays it with the following edges:   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the samr named pipe (this is similar to opening a file with that name) Bind to the samr interface with its UUID 12345778-1234-abcd-ef00-0123456789ac using RPC over SMB Interact using the Security Account Manager (SAM) Remote Protocol The SIDs of users and groups inside of the local group are queried using the function GetMembersInAlias Close and logoff   ...   
SAMR otherwise returns domain users from the ntds.dit database instead of local users.   ...   
Faced with the limitations of SAMR, we will look at the second way SharpHound gathers user rights, the GPOLocalGroup collection method.   ...   
List all OUs that have a GPO linked (gpLink attribute in LDAP) Skip gpLink that contains no computer object, or are disabled Process the gPCFileSysPath attribute of each linked GPO object (this attribute specifies where on SYSVOL the files containing the rules are stored) Search for Groups.xml (for Local Users and Groups) and GptTmpl.inf (for Restricted Groups) in all gPCFileSysPath Filter for SID we’re interested in: Administrators (S-1-5-32-544…..) Remote Desktop Users (S-1-5-32-555…..) Remote Management Users (S-1-5-32-580…..) Distributed COM Users (S-1-5-32-562…..) Resolve what domain users belong to these groups and which computers these GPOs are applied to.   ...   
The completeness of the gathered data will highly vary from domain to domain as some environments heavily rely on GPO to manage local group memberships and other won’t use them at all.   ...   
By default, GPOs are readable by all Authenticated Users, which makes this collection method a good candidate for pentesters and attackers.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 1: User Rights Enumeration Through SAMR & GPOLocalGroup

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/
Краткое содержание: 

<blockquote>
However, it is not always clear how the data is gathered without looking at the code of SharpHound, the data ingestor for BloodHound.   ...   
SharpHound will try to enumerate this information from local group membership and BloodHound displays it with the following edges:   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the samr named pipe (this is similar to opening a file with that name) Bind to the samr interface with its UUID 12345778-1234-abcd-ef00-0123456789ac using RPC over SMB Interact using the Security Account Manager (SAM) Remote Protocol The SIDs of users and groups inside of the local group are queried using the function GetMembersInAlias Close and logoff   ...   
SAMR otherwise returns domain users from the ntds.dit database instead of local users.   ...   
Faced with the limitations of SAMR, we will look at the second way SharpHound gathers user rights, the GPOLocalGroup collection method.   ...   
List all OUs that have a GPO linked (gpLink attribute in LDAP) Skip gpLink that contains no computer object, or are disabled Process the gPCFileSysPath attribute of each linked GPO object (this attribute specifies where on SYSVOL the files containing the rules are stored) Search for Groups.xml (for Local Users and Groups) and GptTmpl.inf (for Restricted Groups) in all gPCFileSysPath Filter for SID we’re interested in: Administrators (S-1-5-32-544…..) Remote Desktop Users (S-1-5-32-555…..) Remote Management Users (S-1-5-32-580…..) Distributed COM Users (S-1-5-32-562…..) Resolve what domain users belong to these groups and which computers these GPOs are applied to.   ...   
The completeness of the gathered data will highly vary from domain to domain as some environments heavily rely on GPO to manage local group memberships and other won’t use them at all.   ...   
By default, GPOs are readable by all Authenticated Users, which makes this collection method a good candidate for pentesters and attackers.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 1: User Rights Enumeration Through SAMR & GPOLocalGroup

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/
Краткое содержание: 

<blockquote>
However, it is not always clear how the data is gathered without looking at the code of SharpHound, the data ingestor for BloodHound.   ...   
SharpHound will try to enumerate this information from local group membership and BloodHound displays it with the following edges:   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the samr named pipe (this is similar to opening a file with that name) Bind to the samr interface with its UUID 12345778-1234-abcd-ef00-0123456789ac using RPC over SMB Interact using the Security Account Manager (SAM) Remote Protocol The SIDs of users and groups inside of the local group are queried using the function GetMembersInAlias Close and logoff   ...   
SAMR otherwise returns domain users from the ntds.dit database instead of local users.   ...   
Faced with the limitations of SAMR, we will look at the second way SharpHound gathers user rights, the GPOLocalGroup collection method.   ...   
List all OUs that have a GPO linked (gpLink attribute in LDAP) Skip gpLink that contains no computer object, or are disabled Process the gPCFileSysPath attribute of each linked GPO object (this attribute specifies where on SYSVOL the files containing the rules are stored) Search for Groups.xml (for Local Users and Groups) and GptTmpl.inf (for Restricted Groups) in all gPCFileSysPath Filter for SID we’re interested in: Administrators (S-1-5-32-544…..) Remote Desktop Users (S-1-5-32-555…..) Remote Management Users (S-1-5-32-580…..) Distributed COM Users (S-1-5-32-562…..) Resolve what domain users belong to these groups and which computers these GPOs are applied to.   ...   
The completeness of the gathered data will highly vary from domain to domain as some environments heavily rely on GPO to manage local group memberships and other won’t use them at all.   ...   
By default, GPOs are readable by all Authenticated Users, which makes this collection method a good candidate for pentesters and attackers.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 2: Session Enumeration Through NetWkstaUserEnum & NetSessionEnum

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-2/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the wkssvc named pipe (this is similar to opening a file with that name) Bind to the wkssvc interface with UUID 6BFFD098-A112-3610-9833-46C3F87E345A using RPC over SMB Interact using the Workstation Service Remote Protocol, call NetWkstaUserEnum Close and logoff   ...   
SharpHound implements “NetWkstaUserEnum” in “ReadUserSessionsPrivileged” method in the CommonLib at: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/Processors/ComputerSessionProcessor.cs and the code relies on native Windows functions to which the P/Invoke signatures are declared in: https://github.com/BloodHoundAD/SharpHoundCommon/blob/master/src/CommonLib/NativeMethods.cs.   ...   
NetSessionEnum   ...   
When using the Session collection method, SharpHound enumerates logged on users by using the NetSessionEnum function.   ...   
In the screenshot above, we see two user accounts which have a session to the target host as well as from which IP the connection is originating.   ...   
The session from user “Administrator” is actually made by NetSess.exe itself!   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the srvsvc named pipe (this is similar to opening a file with that name) Bind to the srvsvc interface with its UUID 4b324fc8-1670-01d3-1278-5a47bf6ee188 Interact using the Server Service Remote Protocol to query NetSessionEnum Close and logoff   ...   
The permissions for who can use NetSessionEnum is defined in the registry value SrvsvcSessionInfo in the hive HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity.   ...   
to:   ...   
What stands out is that level 502 needs higher privileges and this is not mentioned on the Microsoft documentation.   ...   
The technical implementation guide for the Server Service Remote Protocol gives an explanation about permissions for level 502:   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 1: User Rights Enumeration Through SAMR & GPOLocalGroup

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-1/
Краткое содержание: 

<blockquote>
However, it is not always clear how the data is gathered without looking at the code of SharpHound, the data ingestor for BloodHound.   ...   
SharpHound will try to enumerate this information from local group membership and BloodHound displays it with the following edges:   ...   
Establish an SMB connection to the remote host (Kerberos authentication) Connect to the IPC$ share Open the samr named pipe (this is similar to opening a file with that name) Bind to the samr interface with its UUID 12345778-1234-abcd-ef00-0123456789ac using RPC over SMB Interact using the Security Account Manager (SAM) Remote Protocol The SIDs of users and groups inside of the local group are queried using the function GetMembersInAlias Close and logoff   ...   
SAMR otherwise returns domain users from the ntds.dit database instead of local users.   ...   
Faced with the limitations of SAMR, we will look at the second way SharpHound gathers user rights, the GPOLocalGroup collection method.   ...   
List all OUs that have a GPO linked (gpLink attribute in LDAP) Skip gpLink that contains no computer object, or are disabled Process the gPCFileSysPath attribute of each linked GPO object (this attribute specifies where on SYSVOL the files containing the rules are stored) Search for Groups.xml (for Local Users and Groups) and GptTmpl.inf (for Restricted Groups) in all gPCFileSysPath Filter for SID we’re interested in: Administrators (S-1-5-32-544…..) Remote Desktop Users (S-1-5-32-555…..) Remote Management Users (S-1-5-32-580…..) Distributed COM Users (S-1-5-32-562…..) Resolve what domain users belong to these groups and which computers these GPOs are applied to.   ...   
The completeness of the gathered data will highly vary from domain to domain as some environments heavily rely on GPO to manage local group memberships and other won’t use them at all.   ...   
By default, GPOs are readable by all Authenticated Users, which makes this collection method a good candidate for pentesters and attackers.   ...   
</blockquote>

---

# BloodHound Inner Workings & Limitations – Part 3: Session Enumeration Through Remote Registry & Summary

Авторы: 
SVEN DEFATSCH

Ссылка на контент: 
https://blog.compass-security.com/2022/05/bloodhound-inner-workings-part-3/
Краткое содержание: 

<blockquote>
In this series of articles, we deep dive into the enumeration methods of SharpHound and their limitations.   ...   
SharpHound will try to enumerate this information and BloodHound displays it with a HasSession Edge.   ...   
This method was present in SharpHound 2 (the PowerShell one) and later in SharpHound 3.   ...   
The registry can be accessed over the network if the Remote Registry service is running:   ...   
We are interested in the HKEY_USERS hive, since all logged in users on that machine have their NTUSER.DAT a.k.a.   ...   
However, when a server runs a scheduled task as a user, under unknown conditions, the hive will stay loaded since the “System” process is having an open handle on the NTUSER.DAT and other files of the said user.   ...   
If we take a closer look on the permission on the HKEY_USERS hive, we see that Everyone has “Read” access to it.   ...   
This is exactly how SharpHound can enumerate who is logged in on the machine:   ...   
To be precise, the content of the actual key cannot be read by anybody, but the list of subkeys of HKEY_USERS can.   ...   
</blockquote>

---

