{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
{
    "brief": "Email authentication and security is another complex topic that was often misconfigured in the past.       ...        Email protections in Office 365 Email authentication       ...        Email authentication is used to verify if the email server is allowed to send emails on behalf of the sender.       ...        SPF allows to specify which servers are allowed to send emails for your domain through a DNS record.       ...        As an example, a message which does not match the SPF policy will have the following headers in O365:       ...        For instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:       ...        In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject.       ...        If this is such a bad idea, why is this even possible?       ...        Safe senders and domains       ...        When receiving an email in the junk folder, users can choose to add the sender to the safe senders.       ...        Spoofed emails from safe senders will be received in the inbox:       ...        Invalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:       ...        Allowed senders and Safe senders are not safe at all!       ...        On the Outlook desktop client, Safe senders can be disabled by group policy:       ...       ",
    "html_url": "https://blog.compass-security.com/2022/08/email-spoofing-in-office-365/",
    "text": "More and more companies use Microsoft 365, well even we at Compass Security use it. Moving to the cloud solves many issues that our DFIR team had to deal with in the past years. Managed infrastructure means no ProxyShell, Hafnium, etc. We’re grateful for that.\n\nEmail authentication and security is another complex topic that was often misconfigured in the past. We often could send phishing email in the name of our clients during assessments. Office 365 makes the life of scammers and phishers somehow harder. We’re also grateful for that.\n\nHowever we still encounter some O365 environments where it’s possible to send spoofed emails. Why is that, you ask? We also wondered and dug into the O365 features and settings!\n\nEmail protections in Office 365\nEmail authentication\n\nEmail authentication is used to verify if the email server is allowed to send emails on behalf of the sender. O365 supports the well-known triad SPF, DKIM and DMARC.\n\nSender Policy Framework (SPF)\n\nSPF allows to specify which servers are allowed to send emails for your domain through a DNS record. This will be verified by the receiving server. It is active by default and the following policy will be configured (for fully-hosted O365) automatically:\n\n$ dig -t txt +short sender.com\n\"v=spf1 include:spf.protection.outlook.com -all\"\n\nIn turn, due to the include mechanism, the following two records will be queried and taken into account:\n\n$ dig -t txt +short spf.protection.outlook.com\n\"v=spf1 ip4:40.92.0.0/15 ip4:40.107.0.0/16 ip4:52.100.0.0/14 ip4:104.47.0.0/17 ip6:2a01:111:f400::/48 ip6:2a01:111:f403::/48 include:spfd.protection.outlook.com -all\"\n\n$ dig -t txt +short spfd.protection.outlook.com\n\"v=spf1 ip4:51.4.72.0/24 ip4:51.5.72.0/24 ip4:51.5.80.0/27 ip4:20.47.149.138/32 ip4:51.4.80.0/27 ip6:2a01:4180:4051:0800::/64 ip6:2a01:4180:4050:0800::/64 ip6:2a01:4180:4051:0400::/64 ip6:2a01:4180:4050:0400::/64 -all\"\n\nAs an example, a message which does not match the SPF policy will have the following headers in O365:\n\nAuthentication-Results: spf=fail (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=none action=none header.from=sender.com;compauth=fail\n reason=001\nReceived-SPF: Fail (recipient.com: domain of sender.com\n does not designate 1.2.3.4 as permitted sender)\n receiver=recipient.com; client-ip=1.2.3.4;\n helo=mail.sender.com;\n\nSuch a mail (without any other aggravating factor) will not be blocked by O365 without a DMARC policy! SPF alone is not protecting against email spoofing.\n\nDomainKeys Identified Mail (DKIM) \n\nDKIM allows you to add a cryptographic signature to outgoing emails in the message header. The public key is also published in a DNS record. The advantage of DKIM over SPF is that mails can be authenticated even if they get forwarded by a relay server.\n\nThis is not enabled by default in O365 but is supported. A DKIM record looks as follows:\n\n$ dig -t txt +short selector1._domainkey.recipient.com\nselector1-recipient-com01i._domainkey.csnc365.onmicrosoft.com.\n\"v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA0/Cy8ivpKumzFbBGkAxA2ydbglgrwrBss2FT0UmcsveVcE4xC61zuTmEZEWI2LR5HGLElHlgvv83I3C2YvJmuh4i2e+/TLVpLkFxpwYQTkzQT81MazCShfeUS29Zjwr5nBoGAKdAeuL1OOPwWeXznezFIPQxBhe0oWNyYpslD4bKx1bgO+sjvbPLm61ZzEopX\" \"8yQzvyU8XNJX9fLlUJbyo10FLeEU0S3Gs9IfIarucc0gktFMcVsEs72XEJoACkKagL0l5UYqN9CgUg+wuIScbJp6TskN8LQqX+CmHgPPJJLLfaYVuBpbo5oC9F1znN7xPliUDuKxznSDn1CQk49HQIDAQAB;\"\n\nA message which contains a DKIM signature will have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender ip is\n 1.2.3.4) smtp.rcpttodomain=recipient.com\n smtp.mailfrom=sender.com; dmarc=pass (p=reject sp=reject pct=100)\n action=none header.from=sender.com; dkim=pass (signature was\n verified)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=sender.com;\n s=selector1; h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck; bh=yslZcsqEU3doAnzIBv+IiXhdA9VgmTBEY7w17G6s3Ag=;\n b=cD8dhgH352qUE0HvmLeYaWlC4E7xtUl26Sju41TUTDXIKSB/EUNhiOd2K46Q0VdISshkAFieExTbRfHksyl4hK6Ctuzaeaq5m+cPquzZba4Idt2WSNhwxCZyPsTRf7h7cj++t86lexZDfwrfra+8QJsAwInYAXVmC4tC4/lLGS13+FXWWh8/A/eVu+dGP5iuojZtmSAiKc51sRGya89Oup70MeNIz3NarhMbT/0b0o20XuLGWsdrLykMOhNOSoTRlxALyEEQuR2E7tRIA23OtClZt0i6YqtK1lG+VSs1RwNySGlptNnM+Nnf3NMggGkzCuvU4/FpvZ2yMUcucqe5lw==\n\n\nDKIM adds an extra layer of security to your emails, you should configure it if it’s not already done. But how does the recipient knows that it should expect a DKIM signature?\n\nDomain-based Message Authentication, Reporting and Conformance (DMARC)\n\nDMARC helps the recipient server to decide what to do if SPF and/or DKIM checks fail. This feature is also not enabled by default for outgoing emails but supported in O365. It also consists of a TXT DNS record. For instance:\n\n$ dig -t txt +short _dmarc.sender.com\n\"v=DMARC1; p=reject; sp=reject; rua=mailto:security@sender.com!10m; ruf=mailto:security@sender.com!10m; rf=afrf; pct=100; ri=86400\"\n\nWhat does this mean? This can be parsed easily using mtoolbox:\n\nTag\tTagValue\tName\tDescription\nv\tDMARC1\tVersion\tIdentifies the record retrieved as a DMARC record.\np\treject\tPolicy\tPolicy to apply to email that fails the DMARC test.\nsp\treject\tSub-domain Policy\tRequested Mail Receiver policy for all subdomains.\nrua\tmailto:security@sender.com!10m\n\tReceivers\tAddresses to which aggregate feedback is to be sent.\nruf\tmailto:security@sender.com!10m\n\tForensic Receivers\tAddresses to which message-specific failure information is to be reported.\nrf\tafrf\tForensic Format\tFormat to be used for message-specific failure reports. \npct\t100\tPercentage\tPercentage of messages from the Domain Owner’s mail stream to which the DMARC policy is to be applied.\nri\t86400\tReporting Interval\tIndicates a request to Receivers to generate aggregate reports separated by no more than the requested number of seconds.\n\nFor instance, a message passing SPF but without DKIM will be rejected due to a DMARC policy could have the following headers in O365:\n\nAuthentication-Results: spf=pass (sender IP is 1.2.3.4)\n smtp.mailfrom=sender.com; dkim=none (message not signed)\n header.d=none;dmarc=fail action=oreject\n header.from=sender.com;compauth=fail reason=000\n\nAccording to the documentation:\n\noreject or o.reject: Stands for override reject. In this case Microsoft 365 uses this action when it receives a message that fails the DMARC check from a domain whose DMARC TXT record has a policy of p=reject. Instead of deleting or rejecting the message, Microsoft 365 marks the message as spam.\n\nThis email will land in the junk folder in O365, if no bypass is configured. Furthermore, this will gives insight to the company that someone is trying to impersonate their name. For instance here is one such feedback:\n\n<?xml version=\"1.0\"?>\n<feedback>\n\t<version>0.1</version>\n\t<report_metadata>\n\t\t<org_name>AMAZON-SES</org_name>\n\t\t<email>postmaster@amazonses.com</email>\n\t\t<report_id>670e469b-4307-4c2a-870a-7a07869d7c02</report_id>\n\t\t<date_range>\n\t\t\t<begin>1660953600</begin>\n\t\t\t<end>1661040000</end>\n\t\t</date_range>\n\t</report_metadata>\n\t<policy_published>\n\t\t<domain>compass-security.com</domain>\n\t\t<adkim>r</adkim>\n\t\t<aspf>r</aspf>\n\t\t<p>reject</p>\n\t\t<sp>reject</sp>\n\t\t<pct>100</pct>\n\t\t<fo>0</fo>\n\t</policy_published>\n\t<record>\n\t\t<row>\n\t\t\t<source_ip>52.100.1.208</source_ip>\n\t\t\t<count>1</count>\n\t\t\t<policy_evaluated>\n\t\t\t\t<disposition>none</disposition>\n\t\t\t\t<dkim>pass</dkim>\n\t\t\t\t<spf>fail</spf>\n\t\t\t</policy_evaluated>\n\t\t</row>\n\t\t<identifiers>\n\t\t\t<envelope_from></envelope_from>\n\t\t\t<header_from>compass-security.com</header_from>\n\t\t</identifiers>\n\t\t<auth_results>\n\t\t\t<dkim>\n\t\t\t\t<domain>compass-security.com</domain>\n\t\t\t\t<result>pass</result>\n\t\t\t</dkim>\n\t\t\t<spf>\n\t\t\t\t<domain>CHE01-GV0-obe.outbound.protection.outlook.com</domain>\n\t\t\t\t<result>none</result>\n\t\t\t</spf>\n\t\t</auth_results>\n\t</record>\n</feedback>\nAnti-spoofing\n\nSpoofing is a technique often used by attackers to make a message appear as if it would come from someone else. The authentication techniques above are countermeasures against email spoofing.\n\nO365 include so-called “anti-phishing” policies per default (which is actually anti-spoofing). These can not be disabled. Any mail that is recognized as spoofing (using SPF, DKIM and DMARC) will be automatically put in the junk folder, as the example below show:\n\nAlthough the sender appears to be Doris Mc Jannet, this email was sent from another mail server.\n\nAdditional tips and indicators can be enabled through the anti-phishing policy:\n\nAnti-phishing policy configuration (at https://security.microsoft.com/antiphishing)\n\nThese will change the way the mail is shown only in the Outlook client and not in the webmail as follows:\n\nThe so-called “spoof intelligence” feature could not be tested, because even spoofed messages seemed not to trigger it during our testing.\n\nAnti-phishing, anti-spam and anti-malware\n\nUnlike spoofing, phishing, spam and malware are categories of attacks that cannot be identified based on the sender only. In O365, anti-spam and anti-malware policies also exist and are active by default. These cannot be disabled, however can and maybe should be made stricter.\n\nExceptions\n\nThere are several ways to create exceptions in O365 to let spoofed mails through.\n\nAllowed senders and domains\n\nAdministrators can define exceptions to the anti-spam policies. One might think that this disables anti-spam but not anti-spoofing. However, the documentation hints that:\n\nNever add your own accepted domains or common domains (for example, microsoft.com or office.com) to the allowed domains list. If these domains are allowed to bypass spam filtering, attackers can easily send messages that spoof these trusted domains into your organization.\n\nIndeed, when adding the domain “insecure.technology” to the allowed domain, any spoofed email gets into the inbox:\n\nConfigured exception\nSpoofed email received in the inbox\n\nThe recommended settings from Microsoft even states:\n\nAdding domains to the allowed senders list is a very bad idea. Attackers would be able to send you email that would otherwise be filtered out.\n\nIf this is such a bad idea, why is this even possible?\n\nSafe senders and domains\n\nNow, one might expect from O365 administrators that they read the documentation, but it’s another story for users. When receiving an email in the junk folder, users can choose to add the sender to the safe senders.\n\nWe encounter different behavior depending on whether the sender is part of the organization or not.\n\nIntra-organization spoofing\nOutlook online (web)\n\nIf the sender is a valid user inside your organization, O365 offers the possibility to add it to the safe senders list:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\n\nThis has no effect whatsoever when done through the web client (outlook.office.com) and the email or domain will not be added to the list (without any error or warning though). Is this a bug or a feature?\n\nOutlook client (desktop)\n\nWhen this is done in Outlook for desktop, however, the setting is taken into account:\n\nMenu option to add sender to the safe senders list\nPopup confirming the action\nThe setting is taken into account\n\nOne could expect that all spoofing policy still apply to safe senders, but they don’t. Spoofed emails from safe senders will be received in the inbox:\n\nIntra-organization spoofed email received in the inbox\nExtra-organization spoofing\n\nInvalid users in the organization or valid users outside the organization can also be added to the safe sender list, be it in the web or desktop version of outlook:\n\nSenders added to the safe senders in Outlook web\n\nThe same applies to spoofed emails from safe senders outside your organization, they will be received in the inbox:\n\nExtra-organization spoofed emails received in the inbox\nFine print\n\nThe following insights from Microsoft’s documentation are interesting:\n\nThe documentation states that safe sender lists should be avoided\nConclusion\n\nWe’ve seen that email authentication protects effectively against phishing but needs to be configured. Implement DKIM and DMARC today for your domains!\n\nAllowed senders and Safe senders are not safe at all! They will bypass O365 security (except for mails identified as malware or high confidence phishing), Administrator should be aware of this, use the other methods mentioned in this article to create exceptions (mail flow rules or Tenant Allow/Block rules) and monitor safe senders lists.\n\nOn the Outlook desktop client, Safe senders can be disabled by group policy:\n\nGPO configuration for hiding the Safe Senders GUI\n\nHowever, user will still be able to add safe sender via the web client. Safe senders can be audited over the organization using Exchange PowerShell:\n\nFrom an Azure Cloud Shell, connect to Exchange or directly from an Exchange server:\nConnect-EXOPSSession\nAudit safe senders:\n$AllUsers = Get-Mailbox -ResultSize unlimited -RecipientTypeDetails UserMailbox\n$AllUsers | foreach {Get-MailboxJunkEmailConfiguration -Identity $_.UserPrincipalName} | Format-Table -Auto Identity,Enabled,TrustedSendersAndDomains",
    "title": "Email spoofing in Office 365"
}
