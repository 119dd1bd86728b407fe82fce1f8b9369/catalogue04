# Sensecon 23: from Windows drivers to an almost fully working EDR

Авторы: 
None

Ссылка на контент: 
https://sensepost.com/blog/2024/sensecon-23-from-windows-drivers-to-an-almost-fully-working-edr/
Краткое содержание: 

<blockquote>
First we will take a look at the history of anti-viruses, see how they worked and why they relied on a kernel driver, then we will see how to create a custom kernel driver and finally how to turn it into a almost fully working EDR.   ...    Its usage is fully documented and the function is pretty easy to use, all you need to do is to specify the path to the file you want to open as well as the desired access on it (read, write or append).   ...    This instruction is the one that will tell the CPU to switch from the user space to the kernel space and then jump on the kernel address where the NtCreateFile function is located in the kernel.   ...    In order to find the address of the function, it will need both the system call number, stored in the EAX register, and the SSDT.   ...    Because this structure is an index that contains a list of system call numbers as well as the location of the corresponding hexadecimal address of the function in the kernel:   ...    Once the kernel receives the request, it will request a driver (the hard disk driver in our case) to read the content of the file stored on the hard disk which, in the end, will allow notepad to print its content back to you.   ...    Looking back at the SSDT, it appears that if you modify the address of the kernel functions, you can basically redirect the code flow pretty much anywhere you want.   ...    This mechanism is the first one we are going to implement in our EDR, but before we get to that we will need a kernel driver and thus we’ll need to have a better understanding of what a driver is and how we can develop one.   ...    Before you start developing a driver, you will have to determine what your needs are and what your driver will be used for.   ...    In our case, sadly, we’ll need to develop a kernel driver (KMDF) since we will use kernel functions and to develop a driver we will need a development environment!   ...    To do so we’ll have to add the following key:   ...    // Creating the symlink that we will use to contact our driver status = IoCreateSymbolicLink( &symlinkName, // The symbolic link name &deviceName   // The device name );   ...    Now that the driver is running, let’s take a look at the content of a basic Windows kernel driver!   ...    If we take a look at content of the DriverEntry’s function, we can see that, apart from the DbgPrintEx functions used to print messages in dbgview, two functions are called:   ...    In our code, the routine is the following function:   ...    And that’s it, at this point we have got a working kernel driver.   ...    As we have seen before, function callbacks are functions that can be used by a driver to register what is called a kernel callback.   ...    Below you will find a schema that sums up the process of registering a function callback in order to monitor for process creation:   ...    For that reason, each and every EDR’s driver registers kernel callbacks in order to monitor process creation via the PsSetCreateProcessNotifyRoutine function.   ...    The first argument is a pointer to a routine that is going to be executed each time the driver receives a notification from the kernel while the second one specifies whether the callback should be registered or unregistered.   ...    In the following code, this routine is the CreateProcessNotifyRoutine function:   ...    Being aware of process creation sure is interesting but we need to develop logic that is going to allow our EDR to determine whether or not the target process should be created in the first place.   ...    The prototype for this function is the following:   ...    As an attacker these arrays are specifically interesting because if you can overwrite them or remove the pointers, you will basically be able to “blind” the EDR and thus prevent it from monitoring the system (and there is already a pretty cool tool that will allow you doing that, CheekyBlinder).   ...    At this point the only thing I wanted MyDumbEDR to be able to detect is binaries that attempt to inject shellcode into remote process using the following simple CreateRemoteThread technique:   ...    Both these agents will receive information from the driver via a named pipe which is an Internal Process Communication mechanism.   ...    if (isOpenProcessPresent && isVirtualAllocExPresent && isWriteProcessMemoryPresent && isCreateRemoteThreadPresent) { return TRUE; } else { return FALSE; } return FALSE; }   ...    printf("\n\n"); } return 0; }   ...    To modify the flow of a function from NTDLL.dll, we simply need to parse the DLL, find the functions we want to hook and modify its code so that it jumps to the code of our EDR instead.   ...    Because the NtAllocateVirtualMemory is the function from NTDLL.dll that is used to allocate and protect a memory space.   ...    That’s the job of the RemoteInjector agent which receives, from the driver, the PID of the process in which to inject the DLL:   ...    // Opening the process with necessary privileges HANDLE hProcess = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ, FALSE, target_pid); if (hProcess == NULL) { printf("Can't open handle, error: % lu\n", GetLastError()); return FALSE; } printf("\tOpen handle on PID: %d\n", target_pid);   ...    Running all of that, we can see that the assembly code of the NtAllocateVirtualMemory function of the NTDLL.dll of a process that was injected is the following:   ...    As you can see the first assembly instruction of the hooked NtAllocateVirtualMemory function is a jmp which will redirect the code flow from the NTDLL.dll to the address “00007FFAA06A0FD6” which is… Our injected EDR’s DLL:   ...    Now that we have our two agents as well as the driver, we can compile them and launch the entire project to see it in action!   ...    Throughout this article we have seen how to develop a Windows driver, how to turn it into a EDR’s kernel driver and how to build a dummy EDR.   ...   
</blockquote>

---

# Is the Google search bar enough to hack Belgian companies?

Авторы: 
Alpgiray Saygin

Ссылка на контент: 
https://blog.nviso.eu/2024/01/22/is-the-google-search-bar-enough-to-hack-belgium-companies/
Краткое содержание: 

<blockquote>
Below is a short list of vulnerabilities identified during the security research, using only the Google search bar on the web applications of Belgian corporations:   ...    The technique Google Dorking is also referred to as Google hacking, which is a method used by security researchers and cybercriminals to exploit the power of the Google search engine to unearth vulnerabilities on the Internet.   ...    However, we will not share any of the actual Google dork queries or the methodology behind them that were used to identify vulnerabilities.   ...    Therefore, an attacker can easily guess those credentials if not changed and gain access to the management portal.   ...    Upon identifying the target software, the attacker can use a combination of Google search operators to refine the search results to only display web applications hosting that specific management portal.   ...    A lot of management portal software names are written in the title of the web application which is not a security issue at all.   ...    The usage of a single Google dork will, of course, not provide the most refined results to target a specific management portal application.   ...    However, the approach is the same; more advanced operators in combination have to be used in order to target very specific management portals.   ...    To limit the access of robots and web crawlers to your site, you can add the following robots.txt file to the root directory of the web server hosting the management portal application:   ...    The compromise of a web server will not be due to web crawlers indexing the endpoint of a management portal or the presence of a software name within the title tag.   ...    The methodology for identifying LFI vulnerabilities using Google dork may not be as straightforward as identifying management portals.   ...    It is possible to search specifically for these common parameters, which are used for such purposes.   ...    There are several Google search queries that can be used to search for the presence of these parameters in web applications.   ...    The following is an example of a Google dork:   ...    The above shown Google dork query searches web applications with “file” in their URL.   ...    However, as you will notice, these search results will not refine to web applications containing parameters named “file” but will also include directories with the string “file.” During my research, I was able to use a combination of several Google search queries with specific key characters and special characters to refine the search results to web applications only with a “file” parameter in their URL.   ...    As explained above, I developed a methodology that refines Google search results to identify web applications hosted in Belgium, which contain the specific parameters I was targeting.   ...    Do note that depending on the structure of the web application, it might not be possible to create such Disallow entries, since those parameters are used in functionality that is by design intended to be public and should be included in search results.   ...    Test environments are often hosted under a subdomain of the production web applications.   ...    With the information obtained above a Google Dork can be defined to search specifically for web servers containing those subdomains within the URL.   ...    The remediation steps for test environments are quite straightforward.   ...    Sensitive Information Disclosure Description   ...    The Google dork can also be utilized to search for specific strings.   ...    This functionality can be leveraged to search for sensitive strings or directories to discover potentially sensitive information on web servers.   ...    The above search query is used to identify openly accessible directories that include the word ‘app.’ While a directory listing on a web server already presents a security issue, it does not necessarily mean that an attacker will immediately find sensitive information due to this issue.   ...    Finally, during the research I found a lot of web servers exposing sensitive information such as, plain-text database credentials, plain-text credentials of login portals, web server configurations and even such issues which cannot be mentioned.   ...    The methodology in order to identify XSS vulnerabilities is akin to that used for identifying LFI vulnerabilities though the use of Google dork.   ...    Next, refining Google dork queries to target these specific parameters and uncover the web applications for vulnerabilities.   ...    Figure 9 – Asking ChatGPT for a Google Dork   ...    As previously demonstrated, we obtained a Google search query to search for web servers that meet our specific criteria.   ...    For the purposes of the security research, I employed a commonly used XSS payload to demonstrate to the relevant company or organization the presence of such a vulnerability.   ...    Last but not least, how much the above scenario is applicable for the organization in question is for me to know and for the audience to find out.   ...    In order to prevent cybercriminals to uncover sensitive information or vulnerabilities on your web applications using Google dork, a proactive approach is required to manage your online resources.   ...    However, in the case that a developer solely relied on the robots.txt file to hide the sensitive parts of their web application and included those directories and files, this information can act as a roadmap to your sensitive information on your website for attackers.   ...    Below is a real-world example of a robots.txt file used by a web server not allowing to index the top-secret directory.   ...    However, an attacker can gain valuable information by a publicly available file on the web server.   ...    Then, if an attacker can identify a vulnerability such as a LFI I found earlier during this research, without any doubt, it will be the first place to exfiltrate data as a directory called top-secret will most likely contain sensitive information.   ...    However, it can serve as a defense-in-depth approach to take a countermeasure for exposing sensitive information on your web server.   ...    Nevertheless, it has an impact on the likelihood of the vulnerability.   ...    The first factor is what kind of an impact the vulnerability has on the web application in question.   ...    From my research, I concluded that there is not a solid one way solution to prevent attackers easily identifying vulnerabilities and exposed sensitive information on your web servers.   ...    Secure storage of sensitive data: The web server’s file directory should not store sensitive data such as personal information at all.   ...   
</blockquote>

---

# Microsoft Teams Covert Channels Research

Авторы: 
CYRILL BRUNSCHWILER

Ссылка на контент: 
https://blog.compass-security.com/2024/01/microsoft-teams-covert-channels-research/
Краткое содержание: 

<blockquote>
In this article, four covert channels are discussed, with three dedicated to outgoing and the fourth to incoming traffic.   ...    The identified covert channels for outgoing traffic include a webhook, a Teams message, and a Teams call channel.   ...    However, for incoming traffic, the article outlines a message covert channel, which is different from any of the outgoing message channel.   ...    Outgoing Channel: Webhook   ...    In the Microsoft Teams settings, a webhook can be attached to a Teams channel, providing an outside world API to deposit messages in that channel.   ...    Figure 2: Incoming Webhook Covert Channel Flowchart   ...    On the victim side, a Teams card (JSON) is created including an image reference linking to the attacker’s server (AS), appending data to be exfiltrated (resultquery).   ...    The video (Figure 3: Webhook Data Exfiltration Demo) displays a proof-of-concept setup and procedure for how data can be exfiltrated using webhooks.   ...    Afterwards, the victim will launch a script that sends Teams cards to the webhook and appends each entry from a list of strings (data to exfiltrate) to an embedded image, which is then ultimately being requested from the attacker server.   ...    It might not be obvious at first glance but note that prohibiting webhook creation by Teams configuration will not necessarily stop an attacker from creating their own channel with a malicious webhook and using that one for an attack.   ...    However, this would need interception or proxyfication of Teams traffic which is not necessarily supported.   ...    The covert channel can be created by encapsulating the data into UDP packets and sending them over to the relay server.   ...    The incoming packets are not validated by the server and are thus forwarded to the other user on the call (the attacker).   ...    Once the client is successfully authenticated to the relay server, it should be able to send traffic to the server using e.g. UDP.   ...    However, to avoid any confusion, the PoC is designed to inject additional packets to an outgoing UDP call (Figure 4) connection which was previously negotiated using the ICE protocol and all traffic is relayed over an Internet server.   ...    Unfortunately, the call’s UDP packets and the data to exfiltrate, specifically when data is encrypted before exfiltration, have very similar entropy.   ...    This fourth and last covert channel allows for an incoming connection from the attacker to the victim.   ...    The channel exploits the message flow in a similar manner as the previous covert channel.   ...    To send a Microsoft Teams message through the API on https://amer.ng.msg.teams.microsoft.com, the following JSON structure is needed:   ...    It is possible to send HTML instead of text in the “content” field, defining key “messagetype” to “RichText/Html”.   ...    The discovery of covert channels within Microsoft Teams introduces new opportunities for extracting information, even in the presence of security policies and strict egress traffic rules.   ...    Previous work on covert channels using GIF images has already been conducted by Bobbyr, where he introduces the concept of covert channels in MS Teams.   ...   
</blockquote>

---

# Device Code Phishing – Add Your Own Sign-In Methods on Entra ID

Авторы: 
FELIX AEPPLI

Ссылка на контент: 
https://blog.compass-security.com/2024/01/device-code-phishing-add-your-own-sign-in-methods-on-entra-id/
Краткое содержание: 

<blockquote>
This allows an attacker to backdoor the account or perform the self-service password reset for the account with the newly registered sign-in methods.   ...    Basically, a user can start a login flow on one device and finish it on another device with better keyboard input.   ...    To do this, the attacker impersonates an existing application (client) on Azure and, if the phishing is successful, gains the application’s permissions combined with the user’s permissions for the requested resource.   ...    To set a new security key, the ngcmfa claim must be present in the access token.   ...    With the required scope, client ID, token requirements and web application calls, we were able to write a PoC that allows to initiate a device code flow and register a security key for the victim’s account when it is completed.   ...    You can find the PoC code here: https://github.com/CompassSecurity/deviceCode2SecurityKey   ...    It is also possible to register email, phone or TOTP tokens, but this is not implemented in the PoC.   ...    It is now possible to log in as a user without a password or 2FA key.   ...    From our point of view, even though Device Code Phishing is already known and well documented, our attack is new and allows persistence into the account of the target victim.   ...   
</blockquote>

---

